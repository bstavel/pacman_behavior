---
title: 'Ghost vs NoGhost: Approach and Avoidance'
output: html_document
date: '2022-10-31'
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo <- FALSE,  # don't print the code chunk
  warning <- FALSE,  # don't print warnings
  message <- FALSE,  # don't print messages
  fig.width <- 5,  # set default width of figures
  fig.height <- 8,  # set default height of figures
  fig.align <- "center",  # always align figure in center
  fig.pos <- "H",  # always plot figure at the exact location of the code chunk
  cache <- FALSE)  # cache results

## libraries ##
library(tidyverse)
library(ggplot2)
library(ggeffects)
library(magrittr)
library(ggthemr)
library(grid)
library(gtable)
library(gridExtra)
library(wesanderson)
library(ggsci)
library(zoo)
library(kableExtra)
library(lmerTest)
library(RColorBrewer)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(ggcorrplot)
library(viridis)
library(lmtest)
library(gt)
library(survminer)
library(survival)
library(scales)
library(nlme)
library(AICcmodavg)

## hand written functions ##
source(path(here(), "R", 'mutate_cond.R'))
source(path(here(), "R", 'create_distance_df.R'))
source(path(here(), "R", 'clean_behavioral_data.R'))
source(path(here(), "R", 'merge_theta_and_behavioral_data.R'))

## plotting helpers ##
ggthemr("light")
getPalette = colorRampPalette(brewer.pal(25, "Set1"))
ghost_colors <- c("#E48DB7","#55BBC8", "#DE0D16")

c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

# ## parallelization ##
# nCores <- 2
# registerDoParallel(nCores)



```


## Differences in Hippocampal Theta in Approach vs Avoidance in Ghost Trials 

Analyses presented at SFN 2022. Uses linear mixed effects models to compare hippocampal theta during approach vs avoidance during ghost trials


```{r read-data}

# data compiled in `theta_behave_data_prep.Rmd`
## HC #
HC_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_hc_all_subs_ghost.csv"))
HC_no_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_hc_all_subs_noghost.csv"))


## EC #
EC_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ec_all_subs_ghost.csv"))
EC_no_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ec_all_subs_noghost.csv"))


## Amygdala #
AMYG_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_amyg_all_subs_ghost.csv"))
AMYG_no_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_amyg_all_subs_noghost.csv"))

## OFC #
OFC_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ofc_all_subs_ghost.csv"))
OFC_no_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ofc_all_subs_noghost.csv"))


## Anterior Cingulate #
AC_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ac_all_subs_ghost.csv"))
AC_no_ghost_df <- read_csv(path(here(), "results", "theta", "theta_behavior_ac_all_subs_noghost.csv"))

```

```{r prep-df}

HC_ghost_model_df <- HC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) %>%
  mutate(distance_to_ghost = distance_to_ghost - mean(distance_to_ghost))

EC_ghost_model_df <- EC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) %>%
  mutate(distance_to_ghost = distance_to_ghost - mean(distance_to_ghost))


OFC_ghost_model_df <- OFC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) %>%
  mutate(distance_to_ghost = distance_to_ghost - mean(distance_to_ghost))


AC_ghost_model_df <- AC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) %>%
  mutate(distance_to_ghost = distance_to_ghost - mean(distance_to_ghost))


AMYG_ghost_model_df <- AMYG_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) %>%
  mutate(distance_to_ghost = distance_to_ghost - mean(distance_to_ghost))


```


## Modeling


```{r include-temporal-structure, eval = F}


# get model to see if there is an autocorrelation #
aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost,
                            random= ~ 1|subject/electrode/trial_numeric, control = lmeControl(opt = "optim", msVerbose = T),  data = HC_ghost_model_df)

# there is to about 4 time steps #
ACF(aac_model_all_elecs)

aac_model_all_elecs_nocor <- nlme::lme(theta ~ towards_ghost,
                            random= ~ 1|subject/electrode/trial_numeric, control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)

aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)



summary(aac_model_all_elecs_nocor)
summary(aac_model_all_elecs)


AICc(aac_model_all_elecs_nocor) - AICc(aac_model_all_elecs)
```

### Hippocampus


```{r add-other-variables-hc}

hc_aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + 
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = as.data.frame(HC_ghost_model_df))


hc_dist_model_all_elecs <- nlme::lme(theta ~ distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)

hc_reward_model_all_elecs <- nlme::lme(theta ~ discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)


hc_aac_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)

hc_aac_dist_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)

hc_aac_dist_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)


hc_aac_dist_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)


hc_aac_reward_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)


hc_aac_full_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward + towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = HC_ghost_model_df)


```



```{r model-exploration-h}

summary(hc_dist_model_all_elecs)
summary(hc_reward_model_all_elecs)
summary(hc_aac_reward_model_all_elecs)
summary(hc_aac_dist_model_all_elecs)
summary(hc_aac_dist_reward_model_all_elecs)
summary(hc_aac_dist_inter_model_all_elecs)
summary(hc_aac_reward_inter_model_all_elecs)
summary(hc_aac_full_model_all_elecs)


AICc(hc_aac_model_all_elecs) - AICc(hc_aac_dist_inter_model_all_elecs)

```

```{r, eval = F}
library(sjPlot)

ggplot(HC_ghost_model_df, aes(towards_ghost)) +
   # geom_point(size = 0.2) +
   geom_line(aes(y = predict(hc_aac_model_all_elecs), 
                 group = electrode, 
                 color = electrode)) +
   scale_color_manual(values = getPalette(24)) +
   labs(x = "App/Av",
        y = "Theta")



ggplot(HC_ghost_model_df, aes(x = towards_ghost, y = predict(hc_aac_model_all_elecs), fill = subject)) +
   geom_violin() +
   geom_boxplot(width = .4) +
   labs(x = "App/Av",
        y = "Theta") +
  facet_wrap(~subject)


ggplot(HC_ghost_model_df, aes(x = towards_ghost, y = theta, fill = subject)) +
   geom_violin() +
   geom_boxplot(width = .4) +
   labs(x = "App/Av",
        y = "Theta") +
  facet_wrap(~subject)


ggplot(HC_ghost_model_df, aes(x = towards_ghost, y = predict(hc_aac_model_all_elecs), fill = subject)) +
   geom_violin() +
   geom_boxplot(width = .4) +
   labs(x = "App/Av",
        y = "Theta") +
  facet_wrap(~electrode)


ggplot(HC_ghost_model_df, aes(x = towards_ghost, y = theta, fill = subject)) +
   geom_violin() +
   geom_boxplot(width = .4) +
   labs(x = "App/Av",
        y = "Theta") +
  facet_wrap(~electrode)


plot_model(hc_aac_model_all_elecs, type = "pred")

plot_model(hc_aac_model_all_elecs, type = "resid")

plot_residuals(hc_aac_model_all_elecs)

ggpredict(hc_aac_model_all_elecs, terms = c("towards_ghost", "subject"), type = "re") %>% 
   plot() +
   labs(x = "Ap/Av", y = "Theta") + 
   theme_minimal()

ggplot(HC_ghost_model_df, aes(theta, predict(hc_aac_model_all_elecs))) +
   geom_point(size = 0.2) +
  geom_smooth(method = "lm") +
  theme(panel.background = element_rect(fill = "white"))


ranef(hc_aac_model_all_elecs)



plot_residuals(hc_aac_model_all_elecs, remove.estimates = c("subject", "electrode", "trial_time", "trial_numeric",
                                                            "towards_ghost", "UserLocation", "GhostLocation"), 
               show.pred = F, show.resid = T, show.lines = F)


plot(hc_aac_model_all_elecs)


ggplot(data.frame(GhostLocation=HC_ghost_model_df$GhostLocation,pearson=residuals(hc_aac_model_all_elecs,type="pearson")),
      aes(x=GhostLocation,y=pearson)) +
    geom_point(alpha = .2) +
    theme_bw() +
  ggtitle("Ghost Linear")

ggplot(data.frame(UserLocation=HC_ghost_model_df$UserLocation,pearson=residuals(hc_aac_model_all_elecs,type="pearson")),
      aes(x=UserLocation,y=pearson)) +
    geom_point(alpha = .2) +
    theme_bw() +
  ggtitle("Pacman Linear")

ggplot(data.frame(towards_ghost=HC_ghost_model_df$towards_ghost,pearson=residuals(hc_aac_model_all_elecs,type="pearson")),
      aes(x=towards_ghost,y=pearson)) +
    geom_boxplot()+
    theme_bw() +
  ggtitle("Ap/Av Linear")


qqnorm(residuals(hc_aac_model_all_elecs))
```

```{r, eval = F}

HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  filter(trial_id %in% sample(trial_id, 20)) %>%
  ggplot(., aes(x= towards_ghost, y = theta)) +
  geom_boxplot() +
  theme(panel.background = element_rect(fill = "white")) +
  facet_wrap(~trial_id)

HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  filter(towards_ghost == "Towards") %>%
  ggplot(., aes(x= distance_to_ghost, y = theta, color = towards_ghost)) +
  geom_point(alpha = .05, color = "#FCC673") +
  geom_smooth(method = "lm", formula = 'y ~ x',  color = "black", se = T, fill = "grey") +
  theme(panel.background = element_rect(fill = "white")) 


dist_model_plot <- HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  mutate(towards_ghost = if_else(towards_ghost == "Towards", "Approach", "Avoid")) %>%
  mutate(towards_ghost = factor(towards_ghost, levels = c("Avoid", "Approach"))) %>%
  ggplot(., aes(x= distance_to_ghost, y = theta, color = towards_ghost)) +
  geom_point(alpha = .05) +
  geom_smooth(method = "lm", formula = 'y ~ x',  color = "#323639", se = T, fill = "grey") +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none",
            strip.text = element_text(family = "Georgia", color = '#2D2327', size = 18, face = "bold"), 
            axis.title = element_text(family = "Georgia", color = '#2D2327', size = 18), 
            axis.text = element_text(family = "Georgia", color = '#2D2327', size = 13), 
            plot.title = element_text(family = "Georgia", color = '#2D2327', size = 18)) + 
  scale_color_manual(values = c("#009FB8", "#F27D7D")) +
  labs(y = "Theta Power",x = "Distance to ghost") +
  facet_wrap(~towards_ghost, nrow = 2)

ggsave(filename = path(here(), "figures", "brain_lunch", "distance_theta_plot.png"),
     device = "png",
     width = 4,
     height = 6,
     units = "in",
     dpi = 280,
     plot =  dist_model_plot)

```


```{r}



HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  filter(towards_ghost == "Towards") %>%
  ggplot(., aes(x= distance_to_ghost, y = theta, color = towards_ghost)) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", color = "black") +
  theme(panel.background = element_rect(fill = "white")) +
  facet_wrap(~subject)


HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  filter(towards_ghost == "Towards") %>%
  ggplot(., aes(x= distance_to_ghost, y = theta, color = towards_ghost)) +
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", color = "black") +
  theme(panel.background = element_rect(fill = "white")) +
  facet_wrap(~electrode)


# discrete versions

HC_ghost_model_df %>%
  mutate(trial_id = paste(subject, electrode, trial_numeric)) %>%
  filter(towards_ghost == "Towards") %>%
  mutate(dist_tertiles = ntile(distance_to_ghost, 3)) %>%  
  filter(dist_tertiles != 2) %>%
  mutate(dist_tertiles = if_else(dist_tertiles == 3, "Far", "Close")) %>%
  group_by(trial_id) %>%
  # mutate(mean_theta = mean(theta)) %>%
  # select(-theta) %>%
  mutate(elec_id = paste(subject, electrode)) %>%
  group_by(elec_id) %>%
  mutate(pval = round(t.test(theta ~ dist_tertiles)$p.value, 2)) %>%
  mutate(pval = paste(elec_id, pval)) %>%
  distinct() %>%
  ggplot(., aes(x= factor(dist_tertiles), y = theta, fill = factor(dist_tertiles))) +
  geom_boxplot() +
  theme(panel.background = element_rect(fill = "white")) +
  facet_wrap(~pval)

```





## OFC

```{r ofc-modeling}

ofc_aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)


ofc_dist_model_all_elecs <- nlme::lme(theta ~ distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)

ofc_reward_model_all_elecs <- nlme::lme(theta ~ discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)


ofc_aac_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)

ofc_aac_dist_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)

ofc_aac_dist_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)


ofc_aac_dist_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)


ofc_aac_reward_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)


ofc_aac_full_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward + towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = OFC_ghost_model_df)



summary(ofc_dist_model_all_elecs)
summary(ofc_reward_model_all_elecs)
summary(ofc_aac_reward_model_all_elecs)
summary(ofc_aac_dist_model_all_elecs)
summary(ofc_aac_dist_reward_model_all_elecs)
summary(ofc_aac_dist_inter_model_all_elecs)
summary(ofc_aac_reward_inter_model_all_elecs)
summary(ofc_aac_full_model_all_elecs)



AICc(ofc_aac_model_all_elecs) - AICc(ofc_aac_reward_model_all_elecs)


```


## Anterior Cingulate

```{r ac-modeling}

ac_aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + 
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


ac_dist_model_all_elecs <- nlme::lme(theta ~ distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)

ac_reward_model_all_elecs <- nlme::lme(theta ~ discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


ac_aac_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)

ac_aac_dist_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)

ac_aac_dist_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


ac_aac_dist_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


ac_aac_reward_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


ac_aac_full_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward + towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AC_ghost_model_df)


summary(ac_aac_model_all_elecs)
summary(ac_dist_model_all_elecs)
summary(ac_reward_model_all_elecs)
summary(ac_aac_reward_model_all_elecs)
summary(ac_aac_dist_model_all_elecs)
summary(ac_aac_dist_reward_model_all_elecs)
summary(ac_aac_dist_inter_model_all_elecs)
summary(ac_aac_reward_inter_model_all_elecs)
summary(ac_aac_full_model_all_elecs)



AICc(ac_aac_model_all_elecs) - AICc(ac_aac_dist_inter_model_all_elecs)

```


## Amygdala

```{r amyg-modeling}

amyg_aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)

amyg_dist_model_all_elecs <- nlme::lme(theta ~ distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)

amyg_reward_model_all_elecs <- nlme::lme(theta ~ discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)


amyg_aac_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)

amyg_aac_dist_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)

amyg_aac_dist_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)


amyg_aac_dist_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)


amyg_aac_reward_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)


amyg_aac_full_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward + towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = AMYG_ghost_model_df)



summary(amyg_dist_model_all_elecs)
summary(amyg_reward_model_all_elecs)
summary(amyg_aac_reward_model_all_elecs)
summary(amyg_aac_dist_model_all_elecs)
summary(amyg_aac_dist_reward_model_all_elecs)
summary(amyg_aac_dist_inter_model_all_elecs)
summary(amyg_aac_reward_inter_model_all_elecs)
summary(amyg_aac_full_model_all_elecs)


AICc(amyg_aac_model_all_elecs) - AICc(amyg_aac_dist_reward_model_all_elecs)

```


## Entorhinal Cortex

```{r ec-modeling}


ec_aac_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)

ec_dist_model_all_elecs <- nlme::lme(theta ~ distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)

ec_reward_model_all_elecs <- nlme::lme(theta ~ discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)


ec_aac_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost  + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)

ec_aac_dist_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)

ec_aac_dist_reward_model_all_elecs <- nlme::lme(theta ~ towards_ghost + distance_to_ghost + discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)


ec_aac_dist_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)


ec_aac_reward_inter_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)


ec_aac_full_model_all_elecs <- nlme::lme(theta ~ towards_ghost*discounted_reward + towards_ghost*distance_to_ghost +
                           GhostLocation + UserLocation,
                            random= ~ 1|subject/electrode/trial_numeric, correlation=corCAR1(form=~trial_time|subject/electrode/trial_numeric), control = lmeControl(opt = "optim", msVerbose = T), method = "REML",  data = EC_ghost_model_df)



summary(ec_dist_model_all_elecs)
summary(ec_reward_model_all_elecs)
summary(ec_aac_reward_model_all_elecs)
summary(ec_aac_dist_model_all_elecs)
summary(ec_aac_dist_reward_model_all_elecs)
summary(ec_aac_dist_inter_model_all_elecs)
summary(ec_aac_reward_inter_model_all_elecs)
summary(ec_aac_full_model_all_elecs)


AICc(ec_aac_model_all_elecs) - AICc(ec_dist_model_all_elecs)


```



### SFN


```{r sfn-ghost-modeling}


cov_model_all_elecs <-  lmer(theta ~ 
                           GhostLocation + UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = ghost_model_df, REML = F)

aac_model_all_elecs <- lmer(theta ~ towards_ghost +
                           GhostLocation + UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = ghost_model_df, REML = F)

anova(cov_model_all_elecs, aac_model_all_elecs)
AICc(cov_model_all_elecs) - AICc(aac_model_all_elecs)

# ggpredict(aac_model_all_elecs, terms = c("towards_ghost", "electrode"), type = "re") %>% 
#    plot() +
#    labs(x = "Approach/Avoid", y = "Theta", title = "Ghost Trials") + 
#    theme_minimal()

aac_model_all_elecs <- lmerTest::lmer(theta ~ towards_ghost +
                           GhostLocation + UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = ghost_model_df, REML = T)
summary(aac_model_all_elecs)
```



```{r sfn-modeling-table}

aac_model_all_elecs <- lme4::lmer(theta ~ towards_ghost +
                           GhostLocation + UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = ghost_model_df, REML = T)

summary(aac_model_all_elecs)
stargazer(aac_model_all_elecs, type = "text",
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001, .0001),
          digit.separator = "",
          notes        = "*p<0.05; **p<0.01, ***p<0.001, ****p<.0001", notes.append = F)

```



```{r figures}


# Extract the prediction data frame
pred.mm <- ggpredict(aac_model_all_elecs, terms = c("towards_ghost"))  # this gives overall predictions for the model

# Plot the predictions 

(ggplot(pred.mm) + 
   geom_line(aes(x = x, y = predicted)) +          # slope
   geom_ribbon(aes(x = x, ymin = predicted - std.error, ymax = predicted + std.error), 
               fill = "lightgrey", alpha = 0.5) +  # error band
   geom_point(data = ghost_model_df,                      # adding the raw data (scaled values)
              aes(x = towards_ghost, y = theta, colour = subject)) + 
  geom_boxplot(aes(x = x, y = predicted)) +
   labs(x = "Approach/Avoid", y = "Theta", 
        title = "HC Theta during AAC") + 
   theme_minimal() +
    scale_color_manual(values = getPalette(24))
)

getPalette = colorRampPalette(brewer.pal(24, "Set1"))


ggpredict(aac_model_all_elecs, terms = c("towards_ghost", "subject"), type = "re") %>% 
   plot() +
   labs(x = "Approach/Avoid", y = "Theta", title = "HC Theta during AAC") + 
   theme_minimal()


pred.mm
```


```{r lme}
library(nlme)
aac_lme_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                           GhostLocation + UserLocation + trial_time,
                          random=list(subject=~1, electrode=~1, trial_numeric=~1, trial_time=~1), correlation=corAR1(),
                          data = ghost_model_df, method = "REML")

summary(aac_lme_model_all_elecs)

aac_lme_ng_model_all_elecs <- nlme::lme(theta ~ towards_ghost +
                          UserLocation + trial_time,
                          random=list(subject=~1, electrode=~1, trial_numeric=~1, trial_time=~1), correlation=corAR1(),
                          data = no_ghost_model_df, method = "REML")

summary(aac_lme_ng_model_all_elecs)

```

```{r full-mode, eval = F}

  

aac_model_all_elecs <- lmerTest::lmer(theta ~ discounted_reward*towards_ghost + distance_to_ghost*towards_ghost +
                           UserLocation + GhostLocation + trial_time + #poly(trial_time, 2) +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = ghost_df_recenter, REML = T)
summary(aac_model_all_elecs)

full_lme_model_all_elecs <- nlme::lme(theta ~ discounted_reward*towards_ghost + distance_to_ghost*towards_ghost +
                           UserLocation + GhostLocation + trial_time,
                          random=list(subject=~1, electrode=~1, trial_numeric=~1), correlation=corAR1(),
                          data = ghost_model_df, method = "REML")

summary(full_lme_model_all_elecs)

# ar1 for lmer
#(lme_simple_fit <- lme(y~1,random=~1|f,data=d,correlation=corAR1()))
```


```{r no-ghost-modeling}

no_ghost_model_df <- no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = factor(towards_ghost)) %>%
  mutate(discounted_reward = discounted_reward - mean(discounted_reward)) 

cov_model_all_elecs_ng <- lmerTest::lmer(theta ~ 
                           UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = no_ghost_model_df, REML = F)

aac_model_all_elecs_ng <- lmerTest::lmer(theta ~ towards_ghost +
                           UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = no_ghost_model_df, REML = F)


anova(cov_model_all_elecs_ng, aac_model_all_elecs_ng)
AICc(cov_model_all_elecs) - AICc(aac_model_all_elecs)

# show results
aac_model_all_elecs_ng <- lmerTest::lmer(theta ~ towards_ghost +
                           UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = no_ghost_model_df, REML = T)

summary(aac_model_all_elecs_ng)
```


```{r no-ghost-table}

aac_model_all_elecs_ng <- lme4::lmer(theta ~ towards_ghost +
                           UserLocation + trial_time +
                          (1|subject/electrode) + (1|trial_numeric) + (1|trial_time), data = no_ghost_model_df, REML = T)

stargazer(aac_model_all_elecs_ng,
          digits = 3,
          star.cutoffs = c(0.05, 0.01, 0.001, .0001),
          digit.separator = "",
          notes        = "*p<0.05; **p<0.01, ***p<0.001, ****p<.0001", notes.append = F)

```


```{r lme-no-ghost}

library(nlme)
aac_lme_model_all_elecs_ng <- nlme::lme(theta ~ towards_ghost +
                            UserLocation + trial_time,
                          random=list(subject=~1, electrode=~1, trial_numeric=~1, trial_time=~1), correlation=corAR1(),
                          data = no_ghost_df, method = "REML")

summary(aac_lme_model_all_elecs_ng)

```



## Figures presented at SFN

```{r ghost_approach_avoid}

ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  group_by(electrode) %>%
  mutate(pval = round(t.test(theta ~ towards_ghost)$p.value, 7)) %>%
  mutate(electrode = gsub("_trial_theta.csv", "", electrode)) %>%
  mutate(facet_title = paste0(electrode, ": ", pval)) %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
  facet_wrap(~facet_title, nrow = 3) +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior", subtitle = "T tests ran on each elec, p value rounded to the 7th decimal place")

ghost_df %>%
  filter(towards_ghost != "Still") %>%
  filter(subject == "BJH016") %>%
  ungroup() %>%
  group_by(electrode) %>%
  mutate(pval = round(t.test(theta ~ towards_ghost)$p.value, 7)) %>%
  mutate(electrode = gsub("_trial_theta.csv", "", electrode)) %>%
  mutate(facet_title = paste0(electrode, ": ", pval)) %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
  facet_wrap(~facet_title, nrow = 3) +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior", subtitle = "T tests ran on each elec, p value rounded to the 7th decimal place")



ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = elec_aa_theta)) +
  geom_violin() +
  geom_boxplot(notch = T, width = .2) +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding") +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior: Ghost")



# ghost_df %>%
#   filter(towards_ghost != "Still") %>%
#   ungroup() %>%
#   group_by(electrode, trial_numeric, towards_ghost) %>%
#   mutate(trial_aa_theta = mean(theta)) %>%
#   select(subject, electrode, trial_aa_theta, towards_ghost) %>%
#   distinct() %>%
#    ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = trial_aa_theta)) +
#   geom_violin() +
#   # geom_point() +
#   geom_boxplot(notch = T, width = .2) +
#   theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
#   labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
#   facet_wrap(~subject, nrow = 1) +
#   ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior")


```


```{r hc-aac-boxplots}

all_subs_boxplot <- HC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, y = elec_aa_theta)) +
  geom_boxplot(notch = T, fill = "#ffcc00") +
  theme(panel.background = element_rect(fill = "white"), 
      legend.position = "none",
      axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
      axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
      plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24)) + 
  labs(y = "Theta Power", x = "") +
  scale_alpha_manual(values = c(.5, 1)) +
  ggtitle("All subjects\n combined")

indv_subs_boxplot <- HC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  mutate(subject = if_else(subject == "BJH016", "Patient 1",
                           if_else(subject == "LL10", "Patient 2", "Patient 3"))) %>%
  ungroup() %>%
  group_by(electrode, trial_numeric, towards_ghost) %>%
  mutate(trial_aa_theta = mean(theta)) %>%
  select(subject, electrode, trial_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, fill = subject, y = trial_aa_theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "none",
        strip.text = element_blank(),
        axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
        axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
        plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24, hjust = 0.5)) + 
  labs(y = "Theta Power", x = "") +
  scale_fill_manual(values = ghost_colors) +
  scale_alpha_manual(values = c(.5, 1)) +
  facet_wrap(~subject, nrow = 1) +
  scale_y_continuous(position = "right") +
  ggtitle("Individual Subjects")


plot(arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.25,3)))  # 32 inches


ggsave(filename = path(here(), "figures", "brain_lunch", "theta_aac_boxplots.png"),
     device = "png",
     width = 12,
     height = 9,
     units = "in",
     dpi = 340,
     plot =  arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.45,3)))

```

```{r ac-aac-boxplots}

all_subs_boxplot <- AC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, y = elec_aa_theta)) +
  geom_boxplot(notch = T, fill = "#ffcc00") +
  theme(panel.background = element_rect(fill = "white"), 
      legend.position = "none",
      axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
      axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
      plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24)) + 
  labs(y = "Theta Power", x = "") +
  scale_alpha_manual(values = c(.5, 1)) +
  ggtitle("All subjects\n combined")

indv_subs_boxplot <- AC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  mutate(subject = if_else(subject == "BJH016", "Patient 1",
                           if_else(subject == "LL10", "Patient 2", "Patient 3"))) %>%
  ungroup() %>%
  group_by(electrode, trial_numeric, towards_ghost) %>%
  mutate(trial_aa_theta = mean(theta)) %>%
  select(subject, electrode, trial_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, fill = subject, y = trial_aa_theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "none",
        strip.text = element_blank(),
        axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
        axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
        plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24, hjust = 0.5)) + 
  labs(y = "Theta Power", x = "") +
  scale_fill_manual(values = ghost_colors) +
  scale_alpha_manual(values = c(.5, 1)) +
  facet_wrap(~subject, nrow = 1) +
  scale_y_continuous(position = "right") +
  ggtitle("Individual Subjects")


plot(arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.25,3)))  # 32 inches


ggsave(filename = path(here(), "figures", "brain_lunch", "ac_theta_aac_boxplots.png"),
     device = "png",
     width = 12,
     height = 9,
     units = "in",
     dpi = 340,
     plot =  arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.45,3)))

```

```{r ofc-aac-boxplots}

all_subs_boxplot <- OFC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, y = elec_aa_theta)) +
  geom_boxplot(notch = T, fill = "#ffcc00") +
  theme(panel.background = element_rect(fill = "white"), 
      legend.position = "none",
      axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
      axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
      plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24)) + 
  labs(y = "Theta Power", x = "") +
  scale_alpha_manual(values = c(.5, 1)) +
  ggtitle("All subjects\n combined")

indv_subs_boxplot <- OFC_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  mutate(subject = if_else(subject == "BJH016", "Patient 1",
                           if_else(subject == "LL10", "Patient 2", "Patient 3"))) %>%
  ungroup() %>%
  group_by(electrode, trial_numeric, towards_ghost) %>%
  mutate(trial_aa_theta = mean(theta)) %>%
  select(subject, electrode, trial_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, fill = subject, y = trial_aa_theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "none",
        strip.text = element_blank(),
        axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
        axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
        plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24, hjust = 0.5)) + 
  labs(y = "Theta Power", x = "") +
  scale_fill_manual(values = ghost_colors) +
  scale_alpha_manual(values = c(.5, 1)) +
  facet_wrap(~subject, nrow = 1) +
  scale_y_continuous(position = "right") +
  ggtitle("Individual Subjects")


plot(arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.25,3)))  # 32 inches


ggsave(filename = path(here(), "figures", "brain_lunch", "ofc_theta_aac_boxplots.png"),
     device = "png",
     width = 12,
     height = 9,
     units = "in",
     dpi = 340,
     plot =  arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.45,3)))

```

```{r amyg-aac-boxplots}

all_subs_boxplot <- AMYG_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, y = elec_aa_theta)) +
  geom_boxplot(notch = F, fill = "#ffcc00") +
  theme(panel.background = element_rect(fill = "white"), 
      legend.position = "none",
      axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
      axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
      plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24)) + 
  labs(y = "Theta Power", x = "") +
  scale_alpha_manual(values = c(.5, 1)) +
  ggtitle("All subjects\n combined")

indv_subs_boxplot <- AMYG_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(towards_ghost = if_else(towards_ghost == "Away", "Avoid", "Approach")) %>%
  mutate(subject = if_else(subject == "BJH016", "Patient 1",
                           if_else(subject == "LL10", "Patient 2", "Patient 3"))) %>%
  ungroup() %>%
  group_by(electrode, trial_numeric, towards_ghost) %>%
  mutate(trial_aa_theta = mean(theta)) %>%
  select(subject, electrode, trial_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, fill = subject, y = trial_aa_theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "none",
        strip.text = element_blank(),
        axis.title = element_text(family = "Georgia", color = '#2D2327', size = 24), 
        axis.text = element_text(family = "Georgia", color = '#2D2327', size = 20), 
        plot.title = element_text(family = "Georgia", color = '#2D2327', size = 24, hjust = 0.5)) + 
  labs(y = "Theta Power", x = "") +
  scale_fill_manual(values = ghost_colors) +
  scale_alpha_manual(values = c(.5, 1)) +
  facet_wrap(~subject, nrow = 1) +
  scale_y_continuous(position = "right") +
  ggtitle("Individual Subjects")


plot(arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.25,3)))  # 32 inches


ggsave(filename = path(here(), "figures", "brain_lunch", "amyg_theta_aac_boxplots.png"),
     device = "png",
     width = 12,
     height = 9,
     units = "in",
     dpi = 340,
     plot =  arrangeGrob(grobs = list(all_subs_boxplot,indv_subs_boxplot), nrow = 1, ncol = 2, widths = c(1.45,3)))

```




```{r ghost_approach_avoid}

no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  group_by(electrode) %>%
  mutate(pval = round(t.test(theta ~ towards_ghost)$p.value, 7)) %>%
  mutate(electrode = gsub("_trial_theta.csv", "", electrode)) %>%
  mutate(facet_title = paste0(electrode, ": ", pval)) %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
  facet_wrap(~facet_title, nrow = 3) +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior", subtitle = "T tests ran on each elec, p value rounded to the 7th decimal place")


no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = elec_aa_theta)) +
  geom_violin() +
  geom_boxplot(notch = T, width = .2) +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior: No Ghost")


no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  ggplot(., aes(x = towards_ghost, fill =towards_ghost, y = theta)) +
  geom_violin() +
  theme(panel.background = element_rect(fill = "white"), legend.position = "none") +
  labs(y = "Theta Power", x = "Approaching or Avoiding Reward") +
  ggtitle("HC Electrode Theta Power by Approach/Avoid Behavior: No Ghost")

all_subs_ng_boxplot <- no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  ungroup() %>%
  group_by(electrode, towards_ghost) %>%
  mutate(elec_aa_theta = mean(theta)) %>%
  select(electrode, elec_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, y = elec_aa_theta)) +
  geom_boxplot(notch = T, fill = "#ffcc00") +
  theme(panel.background = element_rect(fill = "white"), 
      legend.position = "none",
      legend.title = element_text(family = "Georgia", color = '#2D2327', size = 16),
      legend.text = element_text(family = "Georgia", color = '#2D2327', size = 16),
      axis.title = element_text(family = "Georgia", color = '#2D2327', size = 18), 
      axis.text = element_text(family = "Georgia", color = '#2D2327', size = 14), 
      plot.title = element_text(family = "Georgia", color = '#2D2327', size = 18)) + 
  labs(y = "Theta Power", x = "") +
  scale_alpha_manual(values = c(.5, 1)) +
  ggtitle("All subjects averaged \n within electrode")


indv_subs_ng_boxplot <- no_ghost_df %>%
  filter(towards_ghost != "Still") %>%
  mutate(subject = if_else(subject == "BJH016", "Patient 1",
                           if_else(subject == "LL10", "Patient 2", "Patient 3"))) %>%
  ungroup() %>%
  group_by(electrode, trial_numeric, towards_ghost) %>%
  mutate(trial_aa_theta = mean(theta)) %>%
  select(subject, electrode, trial_aa_theta, towards_ghost) %>%
  distinct() %>%
  ggplot(., aes(x = towards_ghost, alpha =towards_ghost, fill = subject, y = trial_aa_theta)) +
  geom_boxplot(notch = T) +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "none",
        strip.text =  element_text(family = "Georgia", color = '#2D2327', size = 16),
        legend.title = element_text(family = "Georgia", color = '#2D2327', size = 16),
        legend.text = element_text(family = "Georgia", color = '#2D2327', size = 16),
        axis.title = element_text(family = "Georgia", color = '#2D2327', size = 18), 
        axis.text = element_text(family = "Georgia", color = '#2D2327', size = 14), 
        plot.title = element_text(family = "Georgia", color = '#2D2327', size = 18, hjust = 0.5)) + 
  labs(y = "Theta Power", x = "") +
  scale_fill_manual(values = ghost_colors) +
  scale_alpha_manual(values = c(.5, 1)) +
  facet_wrap(~subject, nrow = 1) +
  scale_y_continuous(position = "right") +
  ggtitle("Individual Subjects")


plot(arrangeGrob(grobs = list(all_subs_ng_boxplot,indv_subs_ng_boxplot), nrow = 1, ncol = 2, widths = c(1.25,3)))  # 32 inches


ggsave(filename = path(here(), "figures", "SFN", "theta_aac_ng_boxplots.tif"),
     device = "tiff",
     width = 12,
     height = 7.5,
     units = "in",
     dpi = 320,
     plot =  arrangeGrob(grobs = list(all_subs_ng_boxplot,indv_subs_ng_boxplot), nrow = 1, ncol = 2, widths = c(1.45,3)))

```



Triple check that they do not apporach more when moving right/left.



