---
title: "Elevated Hippocampal Activity at Turnaround"
output: html_document
date: "2024-03-26"
---

```{r setup, include=FALSE}
## libraries ##
library(tidyverse)
library(ggplot2)
library(lmerTest)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(lmtest)
library(scales)
library(ggthemr)
library(RColorBrewer)
library(broom.mixed)

## hand written functions ##
source(path(here(), "R", 'mutate_cond.R'))
source(path(here(), "R", 'create_distance_df.R'))
source(path(here(), "R", 'clean_behavioral_data.R'))
source(path(here(), "R", 'compile_ieeg_csv_files.R'))
source(path(here(), "R", 'run_and_plot_lme_models.R'))

## plotting helpers ##
ggthemr("light")
ghost_colors <- c("#E48DB7","#55BBC8", "#DE0D16")
getPalette = colorRampPalette(brewer.pal(17, "Set1"))

c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

```

```{r load-data}

hc_theta_data <- read_csv( path(here(), "munge", "theta_ieeg_hc_all_subs_logged_iti_onset.csv"))

# behavioral data #
all_subs_g_dist <- read_csv(path(here(), "munge", "all_subs_complete_distance_df.csv"))
all_subs_ng_dist <- read_csv(path(here(), "munge", "all_subs_noghost_complete_distance_df.csv"))


# merge them
hc_behave_df <- left_join(all_subs_g_dist %>% select(-move_step) %>% mutate(trial_time = round(trial_time, 2)), 
                             hc_theta_data  %>% mutate(trial_time = round(trial_time, 2)), by = join_by(subject, trial_numeric, trial_time))

hc_ng_behave_df <- left_join(all_subs_ng_dist %>% select(-move_step) %>% mutate(trial_time = round(trial_time, 2)), 
                             hc_theta_data  %>% mutate(trial_time = round(trial_time, 2)), by = join_by(subject, trial_numeric, trial_time))


```


## Conflict Trials

```{r data-prep}

hc_turn_df <- hc_behave_df %>%
    # round time so that we can loop over time later
    mutate(trial_time = round(trial_time, 2)) %>%
    # exclude time before they started moving, may be good to look at not doing this as well
    # filiter out ITI
    filter(reward_groups != 99 & !is.na(electrode)) %>%
    # prep electrode variables
    mutate(elec_id = paste0(subject, "_", gsub("_.*", "", electrode))) %>%
    mutate(electrode = gsub("_.*", "", electrode)) %>%
    # shift the time so that time 0 is the start of movement onset
    group_by(elec_id, trial_numeric, subject) %>%
    # filter time so that trials end when the person turnaround for the final time
    mutate(event = if_else(last_away == away_choice & away_choice != 0, 1, 0)) %>%
    mutate(event = replace(event, is.na(event), 0)) %>%
    mutate(turnaround_time = if_else(event == 1, trial_time, 0)) %>%
    mutate(turnaround_time = max(turnaround_time)) %>%
    filter(turnaround_time != 0) %>%
    mutate(turn_time = trial_time - turnaround_time) %>%
    ungroup() %>%
    select(subject, elec_id, theta, trial_numeric, trial_time, turn_time, turnaround_time) %>%
    distinct()




```


```{r hc-theta-turnaround, fig.width = 8, fig.height = 6, warning = F}

hc_power_plot <- hc_turn_df %>%
  mutate(turn_time = round(turn_time, 2)) %>%
  filter(turn_time >= -2 &turn_time <=2) %>%
  group_by(subject, elec_id, turn_time) %>%
  mutate(elec_theta = mean(theta)) %>%
  select(-trial_numeric, -trial_time, -theta) %>%
  distinct()  %>%
  group_by(subject, turn_time) %>%
  mutate(sub_theta = mean(elec_theta)) %>%
  select(-elec_id, -elec_theta) %>%
  distinct() %>%
  group_by(turn_time) %>%
  mutate(average_theta = mean(sub_theta)) %>%
  mutate(sem_theta = sd(sub_theta)/sqrt(n())) %>%
  mutate(average_theta_upper = average_theta + sem_theta) %>%
  mutate(average_theta_lower = average_theta - sem_theta) %>%
  ggplot(aes(x = turn_time, y = average_theta)) +
  geom_point(color = "#FFA602") +
  geom_line(color = "#FFA602") +
  geom_ribbon(aes(ymin = average_theta_lower, ymax = average_theta_upper), alpha = 0.2, fill = "#FFA602") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "top",
        axis.text = element_text(family = "Gill Sans", color = "#2D2327", size = 14),
        axis.title = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        legend.text  = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.subtitle = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.title = element_text(family = "Gill Sans", color = "#2D2327", size = 18)) +
  labs(y = "Average theta power  (a.u.)", x = "Time from Turnaround (s)", fill = "", color = "") +
  ggtitle("Average theta power across trials")

ggsave(path(here(), "figures", "hc_theta_plot.png"), 
       plot = hc_power_plot, width = 8, height = 6)

```


```{r get-sig-times}


aac_df <- hc_turn_df %>%
  mutate(aac_time = if_else(turn_time <=0, abs(turn_time), turn_time)) %>%
  mutate(aac_time = round(aac_time, 2)) %>%
  mutate(aac = if_else(turn_time <=0, "approach", "avoid")) %>%
  group_by(elec_id, aac, aac_time) %>%
  mutate(elec_theta = mean(theta)) %>%
  select(-trial_numeric, -trial_time, -theta, -turn_time, -turnaround_time) %>%
  distinct()  %>%
  filter(aac_time <= 2 & aac_time > 0)
  
pvals <- tibble(aac_time = numeric(), pval = numeric())

for(time_step in unique(aac_df$aac_time)){
  
  time_df <- aac_df %>%
    filter(aac_time == time_step)
  
  model_tmp <- tidy(lmer(elec_theta ~ aac + (1|subject), data = time_df))
  
  pval_tmp <- model_tmp %>%
    filter(term == "aacavoid") %>%
    pull(p.value)
  
  pvals <- bind_rows(pvals, tibble(aac_time = time_step, pval = pval_tmp))
  
}

pvals <- pvals %>%
  mutate(p_fdr = p.adjust(pval, method = "fdr"))

```

```{r plot, fig.width = 8, fig.height = 6, warning = F}

aac_test_df <- left_join(aac_df, pvals, by = "aac_time")

app_av_plot <- aac_test_df %>%
  group_by(subject, aac, aac_time) %>%
  mutate(sub_theta = mean(elec_theta)) %>%
  select(-elec_id, -elec_theta) %>%
  distinct() %>%
  group_by(aac, aac_time) %>%
  mutate(average_theta = mean(sub_theta)) %>%
  mutate(sem_theta = sd(sub_theta)/sqrt(n())) %>%
  mutate(average_theta_upper = average_theta + sem_theta) %>%
  mutate(average_theta_lower = average_theta - sem_theta) %>%
  mutate(sig = if_else(p_fdr < 0.05, .75, 999)) %>%
  ggplot(aes(x = aac_time, y = average_theta, color = aac, fill = aac)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = average_theta_lower, ymax = average_theta_upper), alpha = 0.2) +
  geom_label(aes(y = sig), label = "*", color = "black", fill = "white") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "top",
        axis.text = element_text(family = "Gill Sans", color = "#2D2327", size = 14),
        axis.title = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        legend.text  = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.subtitle = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.title = element_text(family = "Gill Sans", color = "#2D2327", size = 18)) +
  scale_color_manual(values = c("#E48DB7","#55BBC8")) +
  scale_fill_manual(values = c("#E48DB7","#55BBC8")) +
  scale_x_reverse() +
  ylim(-.5, 1) +
  labs(y = "Average theta power (a.u.)", x = "Time from Turnaround (s)", fill = "", color = "") +
  ggtitle("Average theta power during approach and avoidance", subtitle = "Significance denoted by *, FDR-corrected for time")


ggsave(path(here(), "figures", "hc_app_avoid_theta_plot.png"), 
       plot = app_av_plot, width = 8, height = 6)


```


## No Conflict Trials

```{r data-prep}

hc_ng_turn_df <- hc_ng_behave_df %>%
    # round time so that we can loop over time later
    mutate(trial_time = round(trial_time, 2)) %>%
    # exclude time before they started moving, may be good to look at not doing this as well
    # filiter out ITI
    filter(reward_groups != 99 & !is.na(electrode)) %>%
    # prep electrode variables
    mutate(elec_id = paste0(subject, "_", gsub("_.*", "", electrode))) %>%
    mutate(electrode = gsub("_.*", "", electrode)) %>%
    # shift the time so that time 0 is the start of movement onset
    group_by(elec_id, trial_numeric, subject) %>%
    # filter time so that trials end when the person turnaround for the final time
    mutate(event = if_else(last_away == away_choice & away_choice != 0, 1, 0)) %>%
    mutate(event = replace(event, is.na(event), 0)) %>%
    mutate(turnaround_time = if_else(event == 1, trial_time, 0)) %>%
    mutate(turnaround_time = max(turnaround_time)) %>%
    filter(turnaround_time != 0) %>%
    mutate(turn_time = trial_time - turnaround_time) %>%
    ungroup() %>%
    select(subject, elec_id, theta, trial_numeric, trial_time, turn_time, turnaround_time) %>%
    distinct()




```

```{r get-sig-times}


aac_ng_df <- hc_ng_turn_df %>%
  mutate(aac_time = if_else(turn_time <=0, abs(turn_time), turn_time)) %>%
  mutate(aac_time = round(aac_time, 2)) %>%
  mutate(aac = if_else(turn_time <=0, "approach", "avoid")) %>%
  group_by(elec_id, aac, aac_time) %>%
  mutate(elec_theta = mean(theta)) %>%
  select(-trial_numeric, -trial_time, -theta, -turn_time, -turnaround_time) %>%
  distinct()  %>%
  filter(aac_time <= 2 & aac_time > 0)
  
pvals <- tibble(aac_time = numeric(), pval = numeric())

for(time_step in unique(aac_ng_df$aac_time)){
  
  time_df <- aac_ng_df %>%
    filter(aac_time == time_step)
  
  model_tmp <- tidy(lmer(elec_theta ~ aac + (1|subject), data = time_df))
  
  pval_tmp <- model_tmp %>%
    filter(term == "aacavoid") %>%
    pull(p.value)
  
  pvals <- bind_rows(pvals, tibble(aac_time = time_step, pval = pval_tmp))
  
}

pvals <- pvals %>%
  mutate(p_fdr = p.adjust(pval, method = "fdr"))

```

```{r plot, fig.width = 8, fig.height = 6, warning = F}

aac_ng_test_df <- left_join(aac_ng_df, pvals, by = "aac_time")

app_av_ng_plot <- aac_ng_test_df %>%
  group_by(subject, aac, aac_time) %>%
  mutate(sub_theta = mean(elec_theta)) %>%
  select(-elec_id, -elec_theta) %>%
  distinct() %>%
  group_by(aac, aac_time) %>%
  mutate(average_theta = mean(sub_theta)) %>%
  mutate(sem_theta = sd(sub_theta)/sqrt(n())) %>%
  mutate(average_theta_upper = average_theta + sem_theta) %>%
  mutate(average_theta_lower = average_theta - sem_theta) %>%
  mutate(sig = if_else(p_fdr < 0.05, .75, 999)) %>%
  ggplot(aes(x = aac_time, y = average_theta, color = aac, fill = aac)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = average_theta_lower, ymax = average_theta_upper), alpha = 0.2) +
  geom_label(aes(y = sig), label = "*", color = "black", fill = "white") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "top",
        axis.text = element_text(family = "Gill Sans", color = "#2D2327", size = 14),
        axis.title = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        legend.text  = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.subtitle = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.title = element_text(family = "Gill Sans", color = "#2D2327", size = 18)) +
  scale_color_manual(values = c("#E48DB7","#55BBC8")) +
  scale_fill_manual(values = c("#E48DB7","#55BBC8")) +
  scale_x_reverse() +
  ylim(-.5, 1) +
  labs(y = "Average theta power (a.u.)", x = "Time from Turnaround (s)", fill = "", color = "") +
  ggtitle("Average theta power no-conflict trials", subtitle = "Significance denoted by *, FDR-corrected for time")


ggsave(path(here(), "figures", "hc_app_avoid_ng_theta_plot.png"), 
       plot = app_av_ng_plot, width = 8, height = 6)


```


## Attack Trials

```{r read-in-attack-tables}

## load and compile attack tables ##
for(sub in unique(aac_df$subject)){
  
  tmp <- read_csv(path(here(), "data", "ieeg_behave", paste0(sub, "_attack_events.csv")))
  tmp <- tmp %>%
    mutate(subject = sub)
  
  if(exists("attack_events")){
    attack_events <- bind_rows(attack_events, tmp)
  } else {
    attack_events <- tmp
  }
  
}

## modify to get trials of interest ##
attack_events <- attack_events %>%
  mutate(trial_numeric = neural_trial_numeric + 1) %>%
  mutate(attacks_ids = paste0(subject, "_", trial_numeric))


```


```{r}

aac_attack_df <- hc_turn_df %>%
  mutate(trial_ids = paste0(subject, "_", trial_numeric)) %>%
  filter(!trial_ids %in% attack_events$attacks_ids) %>%
  mutate(aac_time = if_else(turn_time <=0, abs(turn_time), turn_time)) %>%
  mutate(aac_time = round(aac_time, 2)) %>%
  mutate(aac = if_else(turn_time <=0, "approach", "avoid")) %>%
  group_by(elec_id, aac, aac_time) %>%
  mutate(elec_theta = mean(theta)) %>%
  select(-trial_numeric, -trial_time, -theta, -turn_time, -trial_ids, -turnaround_time) %>%
  distinct()  %>%
  filter(aac_time <= 2 & aac_time > 0)

pvals <- tibble(aac_time = numeric(), pval = numeric())

for(time_step in unique(aac_attack_df$aac_time)){
  
  time_df <- aac_attack_df %>%
    filter(aac_time == time_step)
  
  model_tmp <- tidy(lmer(elec_theta ~ aac + (1|subject), data = time_df))
  
  pval_tmp <- model_tmp %>%
    filter(term == "aacavoid") %>%
    pull(p.value)
  
  pvals <- bind_rows(pvals, tibble(aac_time = time_step, pval = pval_tmp))
  
}

pvals <- pvals %>%
  mutate(p_fdr = p.adjust(pval, method = "fdr"))

```

```{r plot, fig.width = 8, fig.height = 6, warning = F}

aac_attack_test_df <- left_join(aac_attack_df, pvals, by = "aac_time")

aac_attack_test_df %>%
  group_by(subject, aac, aac_time) %>%
  mutate(sub_theta = mean(elec_theta)) %>%
  select(-elec_id, -elec_theta) %>%
  distinct() %>%
  group_by(aac, aac_time) %>%
  mutate(average_theta = mean(sub_theta)) %>%
  mutate(sem_theta = sd(sub_theta)/sqrt(n())) %>%
  mutate(average_theta_upper = average_theta + sem_theta) %>%
  mutate(average_theta_lower = average_theta - sem_theta) %>%
  mutate(sig = if_else(p_fdr < 0.05, .75, 999)) %>%
  ggplot(aes(x = aac_time, y = average_theta, color = aac, fill = aac)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = average_theta_lower, ymax = average_theta_upper), alpha = 0.2) +
  geom_label(aes(y = sig), label = "*", color = "black", fill = "white") +
  geom_vline(xintercept = 0, color = "black", linetype = "dashed") +
  theme(panel.background = element_rect(fill = "white"), 
        legend.position = "top",
        axis.text = element_text(family = "Gill Sans", color = "#2D2327", size = 14),
        axis.title = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        legend.text  = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.subtitle = element_text(family = "Gill Sans", color = "#2D2327", size = 16),
        plot.title = element_text(family = "Gill Sans", color = "#2D2327", size = 18)) +
  scale_color_manual(values = c("#E48DB7","#55BBC8")) +
  scale_fill_manual(values = c("#E48DB7","#55BBC8")) +
  scale_x_reverse() +
  ylim(-.5, 1) +
  labs(y = "Average Theta Power", x = "Time from Turnaround (s)", fill = "", color = "") +
  ggtitle("Average theta power during approach and avoidance", subtitle = "Significance denoted by *, FDR-corrected for time")



```


