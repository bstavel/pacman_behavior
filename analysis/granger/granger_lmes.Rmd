---
title: "Granger Analyses"
output: html_document
date: "2025-02-11"
---

```{r setup, include=FALSE}
## libraries ##
library(tidyverse)
library(ggplot2)
library(lmerTest)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(lmtest)
library(scales)
library(ggthemr)
library(RColorBrewer)
library(broom.mixed)
library(brms)

## hand written functions ##
source(path(here(), "R", 'mutate_cond.R'))
source(path(here(), "R", 'create_distance_df.R'))
source(path(here(), "R", 'clean_behavioral_data.R'))
source(path(here(), "R", 'compile_ieeg_csv_files.R'))
source(path(here(), "R", 'run_and_plot_lme_models.R'))
source(path(here(), "R", 'separate_mfg_sfg.R'))

## plotting helpers ##
ggthemr("light")
ghost_colors <- c("#E48DB7","#55BBC8", "#DE0D16")
getPalette = colorRampPalette(brewer.pal(17, "Set1"))

c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)

```


## Rerun using average Granger across multiple granger thresholds


```{r load-data}

granger_df <- read_csv(path(here(), "results", "granger", "all_subs_all_roi_true_granger_dir.csv"))


```
```{r create-average-model}

granger_df <- granger_df %>%
  mutate(pair_id = paste0(subject, "_", pair)) %>%
  group_by(subject, pair) %>%
  mutate(pval_fdr = p.adjust(pval, method = "fdr")) %>%
  mutate(sig = pval_fdr < 0.05) %>%
  mutate(sig_count = sum(sig)) %>%
  ungroup()

granger_100_sig_df <- granger_df %>%
  filter(sig_count >= 10)

granger_100a_sig_df <- granger_df %>%
  filter(times <= 0) %>%
  group_by(subject, pair) %>%
  mutate(sig_count = sum(sig)) %>%
  filter(sig_count >= 10) %>%
  ungroup()

granger_500_sig_df <- granger_df %>%
  filter(sig_count >= 50)

granger_1000_sig_df <- granger_df %>%
  filter(sig_count >= 100)


```


## Original, 500ms

```{r}

granger_avg_sig_df <- granger_500_sig_df %>%
  mutate(case = if_else(times <= 0, "Approach", "Avoid")) %>%
  group_by(case, subject, pair_id) %>%
  mutate(avg_granger = mean(granger)) %>%
  select(-times, -granger, -pval, -pval_fdr, -`Unnamed: 0`, -sig) %>%
  distinct()


amyg_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_amyg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_amyg") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

mfg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "mfg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 
  


```

```{r}

options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")
priors <- c(
  prior(normal(0, 2), class = "Intercept"),            # Prior for the intercept                 # Prior for fixed effects
    prior(exponential(1), class = "sd")                 # Prior for random effects standard deviations 
)

## Amyg Cing
# Fit the model
amyg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_cing_app_model, file = path(here(), "results", "granger", "granger_approach_amyg_cing.RData"))



## AMYG OFC
# Fit the model
amyg_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_ofc_app_model, file = path(here(), "results", "granger", "granger_approach_amyg_ofc.RData"))

# AMYG MFG
# Fit the model
amyg_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_mfg_app_model, file = path(here(), "results", "granger", "granger_approach_amyg_mfg.RData"))

## HC OFC
# Fit the model
hc_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_ofc_app_model, file = path(here(), "results", "granger", "granger_approach_hc_ofc.RData"))

## HC CING
# Fit the model
hc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_cing_app_model, file = path(here(), "results", "granger", "granger_approach_hc_cing.RData"))

## HC AMYG
# Fit the model
hc_amyg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_amyg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_amyg_app_model, file = path(here(), "results", "granger", "granger_approach_hc_amyg.RData"))



## OFC MFG
# Fit the model
ofc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_mfg_app_model, file = path(here(), "results", "granger_approach_ofc_mfg.RData"))

## HC MFG
# Fit the model
hc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_mfg_app_model, file = path(here(), "results", "granger", "granger_approach_hc_mfg.RData"))



## OFC CING
# Fit the model
ofc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_cing_app_model, file = path(here(), "results", "granger", "granger_approach_ofc_cing.RData"))

## MFG CING
# Fit the model
mfg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = mfg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(mfg_cing_app_model, file = path(here(), "results", "granger_approach_mfg_cing.RData"))
```

```{r open-print-all-models}

orig_500 <- NULL

## Amyg ~ Cing
# load
load(path(here(), "results", "granger", "granger_approach_amyg_cing.RData"))
# summary
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['Amyg_Cing'] <- prob_mu_gt_0

## HC ~ Cing
# load
load(path(here(), "results", "granger", "granger_approach_hc_cing.RData"))
# summary
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['HC_Cing'] <- prob_mu_gt_0

## HC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_approach_hc_amyg.RData"))
# summary
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['HC_Amyg'] <- prob_mu_gt_0

## MFG ~ Amyg
# load
load(path(here(), "results", "granger", "granger_approach_amyg_mfg.RData"))
# summary
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['Amyg_MFG'] <- prob_mu_gt_0

## OFC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_approach_amyg_ofc.RData"))
# summary
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['Amyg_OFC'] <- prob_mu_gt_0

## MFG ~ Cing
# load
load(path(here(), "results", "granger", "granger_approach_mfg_cing.RData"))
# summary
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['MFG_Cing'] <- prob_mu_gt_0

## MFG ~ HC
# load
load(path(here(), "results", "granger", "granger_approach_hc_mfg.RData"))
# summary
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['HC_MFG'] <- prob_mu_gt_0


## OFC ~ Cing
# load
load(path(here(), "results", "granger", "granger_approach_ofc_cing.RData"))
# summary
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['OFC_Cing'] <- prob_mu_gt_0

## OFC ~ MFG
# load
load(path(here(), "results", "granger", "granger_approach_ofc_mfg.RData"))
# summary
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['OFC_MFG'] <- prob_mu_gt_0


## OFC ~ HC
# load
load(path(here(), "results", "granger", "granger_approach_hc_ofc.RData"))
# summary
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
orig_500['HC_OFC'] <- prob_mu_gt_0



```


## 100ms

```{r}

granger_avg_sig_df <- granger_100_sig_df %>%
  mutate(case = if_else(times <= 0, "Approach", "Avoid")) %>%
  group_by(case, subject, pair_id) %>%
  mutate(avg_granger = mean(granger)) %>%
  select(-times, -granger, -pval, -pval_fdr, -`Unnamed: 0`, -sig) %>%
  distinct()


amyg_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_amyg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_amyg") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

mfg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "mfg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 
  


```

```{r}

options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")
priors <- c(
  prior(normal(0, 2), class = "Intercept"),            # Prior for the intercept                 # Prior for fixed effects
    prior(exponential(1), class = "sd")                 # Prior for random effects standard deviations 
)

## Amyg Cing
# Fit the model
amyg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_cing_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_amyg_cing.RData"))



## AMYG OFC
# Fit the model
amyg_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_ofc_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_amyg_ofc.RData"))

# AMYG MFG
# Fit the model
amyg_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_mfg_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_amyg_mfg.RData"))

## HC OFC
# Fit the model
hc_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_ofc_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_hc_ofc.RData"))

## HC CING
# Fit the model
hc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_cing_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_hc_cing.RData"))

## HC AMYG
# Fit the model
hc_amyg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_amyg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_amyg_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_hc_amyg.RData"))



## OFC MFG
# Fit the model
ofc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_mfg_app_model, file = path(here(), "results", "granger_100ms_approach_ofc_mfg.RData"))

## HC MFG
# Fit the model
hc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_mfg_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_hc_mfg.RData"))



## OFC CING
# Fit the model
ofc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_cing_app_model, file = path(here(), "results", "granger", "granger_100ms_approach_ofc_cing.RData"))

## MFG CING
# Fit the model
mfg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = mfg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(mfg_cing_app_model, file = path(here(), "results", "granger_100ms_approach_mfg_cing.RData"))
```

```{r open-print-all-models}

ms_100 <- NULL

## Amyg ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ms_approach_amyg_cing.RData"))
# summary
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['Amyg_Cing'] <- prob_mu_gt_0

## HC ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ms_approach_hc_cing.RData"))
# summary
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['HC_Cing'] <- prob_mu_gt_0

## HC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ms_approach_hc_amyg.RData"))
# summary
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['HC_Amyg'] <- prob_mu_gt_0

## MFG ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ms_approach_amyg_mfg.RData"))
# summary
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['Amyg_MFG'] <- prob_mu_gt_0

## OFC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ms_approach_amyg_ofc.RData"))
# summary
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['Amyg_OFC'] <- prob_mu_gt_0

## MFG ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ms_approach_mfg_cing.RData"))
# summary
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['MFG_Cing'] <- prob_mu_gt_0

## MFG ~ HC
# load
load(path(here(), "results", "granger", "granger_100ms_approach_hc_mfg.RData"))
# summary
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['HC_MFG'] <- prob_mu_gt_0


## OFC ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ms_approach_ofc_cing.RData"))
# summary
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['OFC_Cing'] <- prob_mu_gt_0

## OFC ~ MFG
# load
load(path(here(), "results", "granger", "granger_100ms_approach_ofc_mfg.RData"))
# summary
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['OFC_MFG'] <- prob_mu_gt_0


## OFC ~ HC
# load
load(path(here(), "results", "granger", "granger_100ms_approach_hc_ofc.RData"))
# summary
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100['HC_OFC'] <- prob_mu_gt_0



```

## 100ms, Approach Only

```{r}

granger_avg_sig_df <- granger_100a_sig_df %>%
  mutate(case = if_else(times <= 0, "Approach", "Avoid")) %>%
  group_by(case, subject, pair_id) %>%
  mutate(avg_granger = mean(granger)) %>%
  select(-times, -granger, -pval, -pval_fdr, -`Unnamed: 0`, -sig) %>%
  distinct()

amyg_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_amyg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_amyg") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

mfg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "mfg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 
  


```

```{r}

options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")
priors <- c(
  prior(normal(0, 2), class = "Intercept"),            # Prior for the intercept                 # Prior for fixed effects
    prior(exponential(1), class = "sd")                 # Prior for random effects standard deviations 
)

## Amyg Cing
# Fit the model
amyg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_cing_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_amyg_cing.RData"))



## AMYG OFC
# Fit the model
amyg_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_ofc_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_amyg_ofc.RData"))

# AMYG MFG
# Fit the model
amyg_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_mfg_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_amyg_mfg.RData"))

## HC OFC
# Fit the model
hc_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_ofc_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_hc_ofc.RData"))

## HC CING
# Fit the model
hc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_cing_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_hc_cing.RData"))

## HC AMYG
# Fit the model
hc_amyg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_amyg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_amyg_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_hc_amyg.RData"))



## OFC MFG
# Fit the model
ofc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_mfg_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_ofc_mfg.RData"))

## HC MFG
# Fit the model
hc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_mfg_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_hc_mfg.RData"))



## OFC CING
# Fit the model
ofc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_cing_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_ofc_cing.RData"))

## MFG CING
# Fit the model
mfg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = mfg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(mfg_cing_app_model, file = path(here(), "results", "granger", "granger_100ams_approach_mfg_cing.RData"))
```

```{r open-print-all-models}

ms_100a <- NULL

## Amyg ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ams_approach_amyg_cing.RData"))
# summary
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['Amyg_Cing'] <- prob_mu_gt_0

## HC ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ams_approach_hc_cing.RData"))
# summary
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['HC_Cing'] <- prob_mu_gt_0

## HC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ams_approach_hc_amyg.RData"))
# summary
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['HC_Amyg'] <- prob_mu_gt_0

## MFG ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ams_approach_amyg_mfg.RData"))
# summary
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['Amyg_MFG'] <- prob_mu_gt_0

## OFC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_100ams_approach_amyg_ofc.RData"))
# summary
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['Amyg_OFC'] <- prob_mu_gt_0

## MFG ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ams_approach_mfg_cing.RData"))
# summary
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['MFG_Cing'] <- prob_mu_gt_0

## MFG ~ HC
# load
load(path(here(), "results", "granger", "granger_100ams_approach_hc_mfg.RData"))
# summary
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['HC_MFG'] <- prob_mu_gt_0


## OFC ~ Cing
# load
load(path(here(), "results", "granger", "granger_100ams_approach_ofc_cing.RData"))
# summary
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['OFC_Cing'] <- prob_mu_gt_0

## OFC ~ MFG
# load
load(path(here(), "results", "granger", "granger_100ams_approach_ofc_mfg.RData"))
# summary
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['OFC_MFG'] <- prob_mu_gt_0


## OFC ~ HC
# load
load(path(here(), "results", "granger", "granger_100ams_approach_hc_ofc.RData"))
# summary
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_100a['HC_OFC'] <- prob_mu_gt_0



```

## 1000ms 

```{r}

granger_avg_sig_df <- granger_1000_sig_df %>%
  mutate(case = if_else(times <= 0, "Approach", "Avoid")) %>%
  group_by(case, subject, pair_id) %>%
  mutate(avg_granger = mean(granger)) %>%
  select(-times, -granger, -pval, -pval_fdr, -`Unnamed: 0`, -sig) %>%
  distinct()


amyg_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

amyg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "amyg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_ofc_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_ofc") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_amyg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_amyg") %>%
  filter(case == "Approach") %>%
  ungroup() 

hc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "hc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 

ofc_mfg_app_df <- granger_avg_sig_df %>%
  filter(region == "ofc_mfg") %>%
  filter(case == "Approach") %>%
  ungroup() 

mfg_cing_app_df <- granger_avg_sig_df %>%
  filter(region == "mfg_cing") %>%
  filter(case == "Approach") %>%
  ungroup() 
  


```

```{r}

options(mc.cores = parallel::detectCores(), brms.backend = "cmdstanr")
priors <- c(
  prior(normal(0, 2), class = "Intercept"),            # Prior for the intercept                 # Prior for fixed effects
    prior(exponential(1), class = "sd")                 # Prior for random effects standard deviations 
)

## Amyg Cing
# Fit the model
amyg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_cing_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_amyg_cing.RData"))



## AMYG OFC
# Fit the model
amyg_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_ofc_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_amyg_ofc.RData"))

# AMYG MFG
# Fit the model
amyg_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = amyg_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(amyg_mfg_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_amyg_mfg.RData"))

## HC OFC
# Fit the model
hc_ofc_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_ofc_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_ofc_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_hc_ofc.RData"))

## HC CING
# Fit the model
hc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_cing_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_hc_cing.RData"))

## HC AMYG
# Fit the model
hc_amyg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_amyg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_amyg_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_hc_amyg.RData"))



## OFC MFG
# Fit the model
ofc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_mfg_app_model, file = path(here(), "results", "granger_1000ms_approach_ofc_mfg.RData"))

## HC MFG
# Fit the model
hc_mfg_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = hc_mfg_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,
  warmup = 1000,
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),
  seed = 1234
)
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(hc_mfg_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_hc_mfg.RData"))



## OFC CING
# Fit the model
ofc_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = ofc_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(ofc_cing_app_model, file = path(here(), "results", "granger", "granger_1000ms_approach_ofc_cing.RData"))

## MFG CING
# Fit the model
mfg_cing_app_model <- brm(
  formula = avg_granger ~ 1 + (1|subject),
  data = mfg_cing_app_df,
  prior = priors,
  family = gaussian(),
  iter = 4000,  # More samples to improve ESS
  warmup = 1000,  # More warmup for better adaptation
  chains = 4,
  cores = 4,
  control = list(adapt_delta = 0.99),  # More precise tuning
  seed = 1234
)
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
#save model
save(mfg_cing_app_model, file = path(here(), "results", "granger_1000ms_approach_mfg_cing.RData"))
```

```{r open-print-all-models}

ms_1000 <- NULL

## Amyg ~ Cing
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_amyg_cing.RData"))
# summary
summary(amyg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['Amyg_Cing'] <- prob_mu_gt_0

## HC ~ Cing
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_hc_cing.RData"))
# summary
summary(hc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['HC_Cing'] <- prob_mu_gt_0

## HC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_hc_amyg.RData"))
# summary
summary(hc_amyg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_amyg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['HC_Amyg'] <- prob_mu_gt_0

## MFG ~ Amyg
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_amyg_mfg.RData"))
# summary
summary(amyg_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['Amyg_MFG'] <- prob_mu_gt_0

## OFC ~ Amyg
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_amyg_ofc.RData"))
# summary
summary(amyg_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(amyg_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['Amyg_OFC'] <- prob_mu_gt_0

## MFG ~ Cing
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_mfg_cing.RData"))
# summary
summary(mfg_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(mfg_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['MFG_Cing'] <- prob_mu_gt_0

## MFG ~ HC
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_hc_mfg.RData"))
# summary
summary(hc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['HC_MFG'] <- prob_mu_gt_0


## OFC ~ Cing
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_ofc_cing.RData"))
# summary
summary(ofc_cing_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_cing_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['OFC_Cing'] <- prob_mu_gt_0

## OFC ~ MFG
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_ofc_mfg.RData"))
# summary
summary(ofc_mfg_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(ofc_mfg_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['OFC_MFG'] <- prob_mu_gt_0


## OFC ~ HC
# load
load(path(here(), "results", "granger", "granger_1000ms_approach_hc_ofc.RData"))
# summary
summary(hc_ofc_app_model)
# Probability that the overall mean is > 0
posterior_samples <- posterior_samples(hc_ofc_app_model)
prob_mu_gt_0 <- mean(posterior_samples$b_Intercept > 0)
cat("P(Overall mean > 0):", prob_mu_gt_0, "\n")
ms_1000['HC_OFC'] <- prob_mu_gt_0



```
## Combine and Create Table

```{r}

# combine orig, app_100, ms_500, and ms_1000 into a df
orig_df <- tibble("500ms" = orig_500, "region_pair" = names(orig_500)) 
app_100_df <- tibble("100ms_app" = ms_100a, "region_pair" = names(ms_100a))
ms_100_df <- tibble("100ms" = ms_100, "region_pair" = names(ms_100))
ms_1000_df <- tibble("1000ms" = ms_1000, "region_pair" = names(ms_1000))
# combine all into one df
combined_df <- orig_df %>%
  left_join(app_100_df, by = "region_pair") %>%
  left_join(ms_100_df, by = "region_pair") %>%
  left_join(ms_1000_df, by = "region_pair") %>%
  ## Adjust direction of OFC_MFG to MFG_OFC,
  mutate(region_pair = if_else(region_pair == "OFC_MFG", "MFG_OFC", region_pair)) %>%
  mutate(`500ms` = if_else(region_pair == "MFG_OFC", 1- `500ms`, `500ms`)) %>%
  mutate(`100ms_app` = if_else(region_pair == "MFG_OFC", 1- `100ms_app`, `100ms_app`)) %>%
  mutate(`100ms` = if_else(region_pair == "MFG_OFC", 1- `100ms`, `100ms`)) %>%
  mutate(`1000ms` = if_else(region_pair == "MFG_OFC", 1- `1000ms`, `1000ms`)) %>%
  mutate_at(vars(-region_pair), ~ round(., 3)) %>%
  select(region_pair, `100ms`, `100ms_app`, `500ms`, `1000ms`) %>%
  rename(
    "Region Pair" = region_pair,
    "100ms" = `100ms`,
    "100ms (App. Only)" = `100ms_app`,
    "500ms" = `500ms`,
    "1000ms" = `1000ms`
  )
  
combined_df %>%
  arrange(desc(`500ms`)) %>%
  gt()

```
